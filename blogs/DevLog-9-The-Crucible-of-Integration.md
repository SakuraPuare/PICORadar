# 开发日志 #9：集成的熔炉——通过测试替身锻造系统级健壮性

**作者：书樱**
**日期：2025年7月21日**

> **摘要**: 本文是PICO Radar项目第一阶段开发日志的收官之作。我们将深入探讨集成测试（Integration Testing）在验证系统级行为中的关键作用。我们将展示如何通过构建一个功能完备的“测试替身”（Test Double）——`mock_client`，来系统性地、自动化地验证服务器在认证、数据广播和服务发现等多个模块交互时的端到端正确性。这不仅是对功能的测试，更是对系统整体健壮性和可靠性的一次全面锻造。

---

大家好，我是书樱！

在过去的系列日志中，我们从零开始，为PICO Radar项目设计了蓝图，搭建了构建系统，用TDD实现了核心逻辑，并攻克了网络编程中的种种难关。我们的代码库中，每一个独立的模块都经过了单元测试的验证。然而，软件开发的一个永恒真理是：**一堆能正常工作的零件，并不总能组装成一辆能正常行驶的汽车。**

今天，我想分享的，就是我们将这些“零件”组装起来，并投入“集成熔炉”进行全面锻造的经历。

### 超越单元测试：集成测试的必要性

我们遵循经典的**测试金字塔 (Testing Pyramid)** 模型。底层是大量的、快速的**单元测试**，它们验证了单个类或函数的正确性。但单元测试有其固有的局限性：它无法验证模块之间的交互。我们的`PlayerRegistry`单元测试通过了，`WebsocketServer`的框架也搭建好了，但它们组合在一起时，能正确地处理一个真实的客户端连接、认证、数据交换的全过程吗？

这就是**集成测试**的用武之地。它的使命，就是验证多个独立开发的模块在协同工作时的正确性。

### 关键工具：作为“测试替身”的`mock_client`

要对我们的`server_app`进行集成测试，我们需要一个能够与之交互的客户端。在等待真实的PICO硬件和Unreal Engine集成之前，我们开发了一个至关重要的工具：`mock_client`。

在测试理论中，`mock_client`是一个典型的**测试替身 (Test Double)**。它是一个功能齐全、但其行为完全由测试脚本控制的真实程序。它能精确地模拟真实客户端的各种行为：
-   通过UDP广播进行服务发现。
-   使用正确或错误的令牌发起认证。
-   上报模拟的位置数据。
-   监听并解析从服务器广播的数据。

通过命令行参数，我们可以指挥`mock_client`扮演不同的“角色”，这使其成为我们自动化集成测试的基石。

### 四大支柱：验证系统关键路径

我们围绕`mock_client`构建了四个核心的集成测试场景，每一个都由一个shell脚本驱动，实现了“启动服务器 -> 运行客户端 -> 验证结果 -> 清理环境”的完全自动化。

1.  **`AuthFailTest` (安全边界测试)**:
    此测试验证服务器能否正确处理提供了无效凭证的客户端。`mock_client`被设计为：只有当服务器因认证失败而**正确地**拒绝或断开连接时，它才会以成功码（0）退出。这验证了系统的安全边界和错误处理路径。

2.  **`AuthSuccessTest` (核心成功路径测试)**:
    与上一个测试相反，它验证了使用有效凭证的客户端能够顺利完成认证。这确保了系统的“正门”是畅通的。

3.  **`BroadcastTest` (核心业务流测试)**:
    这是一个多方交互测试，验证了系统的核心数据管道。
    -   一个`mock_client`扮演“播种者”（Seeder），连接服务器，发送一条数据，然后断开。
    -   另一个`mock_client`扮演“监听者”（Listener），连接服务器，并断言自己收到了一个包含“播种者”数据的**非空**玩家列表。
    这个测试的通过，证明了数据可以完整地从一个客户端流经服务器，再到达另一个客户端。

4.  **`DiscoveryTest` (多协议交互测试)**:
    此测试验证了我们的“零配置”承诺。`mock_client`在不知道服务器IP的情况下，通过UDP广播发现服务器，然后使用获取到的地址建立TCP WebSocket连接，并成功完成认证。它验证了系统在UDP和TCP两种不同协议间协同工作的能力。

### 结语：从“模块正确”到“系统可信”

通过这套严格的集成测试的锻造，PICO Radar项目完成了一次质的飞跃——从“一堆经过单元测试的、功能正确的模块”，演变为“一个其整体行为经过验证的、可信赖的系统”。

这个过程再次印证了一个核心工程理念：**测试不仅是开发的附属品，它本身就是设计和文档的一部分**。我们的测试套件，就是一份描述系统真实行为的、最精确的、可执行的“活文档”。

站在这坚实可靠的基石上，我们为第一阶段的开发画上了一个完美的句号。我们对系统的质量充满了信心，并已为下一阶段的挑战——构建供游戏引擎使用的`client_lib`——做好了充分的准备。

感谢您一路的关注与陪伴，PICO Radar的故事，未完待续。

---
书樱
2025年7月21日